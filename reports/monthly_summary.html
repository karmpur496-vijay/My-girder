<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Monthly Summary - January 2026</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #333; }
    table { border-collapse: collapse; width: 100%; max-width: 900px; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f5f5f5; }
    .summary { margin-bottom: 20px; }
    .chart-container { width: 100%; max-width: 900px; }
    .controls { margin-bottom: 16px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input.token { width: 320px; padding: 6px; }
    button { padding: 6px 10px; }
  </style>
</head>
<body>
  <h1>Monthly Summary — January 2026</h1>

  <div class="controls">
    <label for="token">GitHub Token (optional — only for private repo access):</label>
    <input id="token" class="token" type="password" placeholder="ghp_..." />
    <button id="loadBtn">Load data from repository (API)</button>
    <button id="loadRawBtn">Load public raw (no token)</button>
    <button id="exportPdfBtn">Export to PDF</button>
  </div>

  <div class="summary" id="summary">
    <p>Click "Load data from repository" to fetch <code>data/girder_reports.csv</code> from the repo.</p>
  </div>

  <h2>Details</h2>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Girder No</th>
        <th>Wedges</th>
        <th>Threading</th>
        <th>Stressing</th>
        <th>Grouting</th>
        <th>Labor</th>
      </tr>
    </thead>
    <tbody id="data-table">
      <!-- Rows injected by script -->
    </tbody>
  </table>

  <h2>Trends</h2>
  <div class="chart-container">
    <canvas id="trendChart" width="900" height="400"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // Render table + summary + chart
    function renderTable(records) {
      const tbody = document.getElementById('data-table');
      tbody.innerHTML = '';
      records.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.Date}</td><td>${r['Girder No']}</td><td>${r.Wedges}</td><td>${r.Threading}</td><td>${r.Stressing}</td><td>${r.Grouting}</td><td>${r.Labor}</td>`;
        tbody.appendChild(tr);
      });

      const summary = document.getElementById('summary');
      if (records.length === 0) {
        summary.innerHTML = '<p>No records found.</p>';
        return;
      }

      const totals = records.reduce((acc, r) => {
        acc.wedges += Number(r.Wedges || 0);
        acc.threading += Number(r.Threading || 0);
        acc.stressing += Number(r.Stressing || 0);
        acc.grouting += Number(r.Grouting || 0);
        acc.labor += Number(r.Labor || 0);
        return acc;
      }, {wedges:0, threading:0, stressing:0, grouting:0, labor:0});

      const avg = (k) => (totals[k] / records.length).toFixed(1);

      summary.innerHTML = `
        <p>This report summarizes <code>data/girder_reports.csv</code> from the repository.</p>
        <ul>
          <li>Total records: ${records.length}</li>
          <li>Total Wedges: ${totals.wedges} (avg ${avg('wedges')})</li>
          <li>Total Threading: ${totals.threading} (avg ${avg('threading')})</li>
          <li>Total Stressing: ${totals.stressing} (avg ${avg('stressing')})</li>
          <li>Total Grouting: ${totals.grouting} (avg ${avg('grouting')})</li>
          <li>Total Labor: ${totals.labor} (avg ${avg('labor')})</li>
        </ul>`;

      // Chart
      const labels = records.map(r => r.Date);
      const wedges = records.map(r => Number(r.Wedges || 0));
      const threading = records.map(r => Number(r.Threading || 0));
      const labor = records.map(r => Number(r.Labor || 0));

      const ctx = document.getElementById('trendChart').getContext('2d');
      if (window._chartInstance) window._chartInstance.destroy();
      window._chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            { label: 'Wedges', data: wedges, borderColor: '#1f77b4', backgroundColor: 'rgba(31,119,180,0.1)', tension: 0.2 },
            { label: 'Threading', data: threading, borderColor: '#ff7f0e', backgroundColor: 'rgba(255,127,14,0.1)', tension: 0.2 },
            { label: 'Labor', data: labor, borderColor: '#2ca02c', backgroundColor: 'rgba(44,160,44,0.1)', tension: 0.2 }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
      });
    }

    // Fetch via GitHub REST API and parse with PapaParse
    async function loadGitHubData(token) {
      const url = 'https://api.github.com/repos/karmpur496-vijay/My-girder/contents/data/girder_reports.csv';
      const headers = {};
      if (token) headers['Authorization'] = `token ${token}`;

      const response = await fetch(url, { headers });
      if (!response.ok) {
        const text = await response.text();
        throw new Error(`GitHub API error: ${response.status} ${response.statusText} - ${text}`);
      }

      const fileData = await response.json();
      const csvContent = atob((fileData.content || '').replace(/\s+/g, ''));

      // Use PapaParse to parse CSV reliably (handles quotes, commas inside fields, etc.)
      const parsed = Papa.parse(csvContent, { header: true, skipEmptyLines: true, dynamicTyping: true });
      if (parsed.errors && parsed.errors.length) console.warn('PapaParse warnings/errors:', parsed.errors);
      return parsed.data;
    }

    // Load raw via raw.githubusercontent and parse with PapaParse
    async function loadRawData() {
      const rawUrl = 'https://raw.githubusercontent.com/karmpur496-vijay/My-girder/main/data/girder_reports.csv';
      const res = await fetch(rawUrl);
      if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
      const csv = await res.text();
      const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true, dynamicTyping: true });
      if (parsed.errors && parsed.errors.length) console.warn('PapaParse warnings/errors:', parsed.errors);
      return parsed.data;
    }

    document.getElementById('loadBtn').addEventListener('click', async () => {
      const token = document.getElementById('token').value.trim();
      try {
        const records = await loadGitHubData(token);
        renderTable(records);
      } catch (err) {
        alert('Error loading data: ' + err.message);
      }
    });

    document.getElementById('loadRawBtn').addEventListener('click', async () => {
      try {
        const records = await loadRawData();
        renderTable(records);
      } catch (err) {
        alert('Failed to load raw file: ' + err.message);
      }
    });

    // Export to PDF (uses browser print; user can Save as PDF)
    document.getElementById('exportPdfBtn').addEventListener('click', () => {
      window.print();
    });

    // Optionally preload public data on page load
    // (uncomment to auto-load)
    // loadRawData().then(renderTable).catch(e => console.warn(e));
  </script>
</body>
</html>